<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>マネーフォワード月次データ クリーナー</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; }
    body { font-family: "Yu Gothic UI", "Meiryo", sans-serif; margin: 0; padding: 16px; background: #f7f4ee; color: #2d2820; }
    .app { max-width: 1120px; margin: 0 auto; background: #fffaf0; border: 1px solid #d9cdbd; border-radius: 14px; padding: 16px; }
    .row { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; margin-top: 10px; }
    .panel { margin-top: 12px; padding: 10px; border: 1px solid #d9cdbd; border-radius: 10px; background: #fff; }
    .status { margin-top: 8px; color: #4a4038; }
    .toolbar { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 8px; }
    .toolbar input, .toolbar select { width: 100%; padding: 6px; border: 1px solid #d9cdbd; border-radius: 8px; }
    .toolbar label { display: block; font-size: 12px; color: #4a4038; margin-bottom: 2px; }
    button { border: 0; border-radius: 8px; padding: 8px 12px; background: #167255; color: #fff; font-weight: 700; cursor: pointer; transition: opacity .15s; }
    button:hover { opacity: .85; }
    button:disabled { opacity: .5; cursor: not-allowed; }
    button.secondary { background: #c97d33; }
    button.outline { background: transparent; color: #5f564a; border: 1px solid #d9cdbd; font-weight: 400; }
    table { width: 100%; border-collapse: collapse; font-size: 12px; min-width: 760px; }
    th, td { border-bottom: 1px solid #efe4d5; padding: 6px; white-space: nowrap; text-align: left; }
    .desc-col { width: 320px; max-width: 320px; }
    .desc-cell { width: 320px; max-width: 320px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    th { position: sticky; top: 0; background: #faf4e8; cursor: pointer; user-select: none; }
    th:hover { background: #f0e8d8; }
    th .sort-indicator { font-size: 10px; margin-left: 2px; opacity: .5; }
    th .sort-indicator.active { opacity: 1; }
    .scroll { overflow: auto; border: 1px solid #d9cdbd; border-radius: 8px; background: #fff; margin-top: 8px; }
    .group td { background: #fdf7ec; font-weight: 700; }
    .keeper td { color: #7a7060; font-style: italic; }
    .amt-col { text-align: right; font-variant-numeric: tabular-nums; }

    /* Collapsible sections */
    .section-header { display: flex; align-items: center; gap: 8px; cursor: pointer; user-select: none; margin-top: 14px; }
    .section-header h2 { margin: 0; font-size: 15px; }
    .section-toggle { font-size: 12px; color: #8a7e6e; transition: transform .2s; }
    .section-body { overflow: hidden; transition: max-height .3s ease; }
    .section-body.collapsed { max-height: 0 !important; overflow: hidden; }

    /* Drop zone */
    .drop-zone { border: 2px dashed #d9cdbd; border-radius: 10px; padding: 24px; text-align: center; color: #8a7e6e; margin-top: 10px; transition: border-color .2s, background .2s; }
    .drop-zone.dragover { border-color: #167255; background: #e8f5ef; color: #167255; }
    .drop-zone input[type="file"] { display: none; }
    .drop-zone-label { cursor: pointer; font-weight: 700; color: #167255; text-decoration: underline; }

    /* Loading overlay */
    .loading-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,250,240,.85); z-index: 1000; justify-content: center; align-items: center; flex-direction: column; gap: 12px; }
    .loading-overlay.active { display: flex; }
    .spinner { width: 36px; height: 36px; border: 4px solid #d9cdbd; border-top-color: #167255; border-radius: 50%; animation: spin .8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .loading-text { font-size: 14px; color: #5f564a; }

    /* Stats cards */
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 8px; }
    .stat-card { background: #faf4e8; border-radius: 8px; padding: 10px; text-align: center; }
    .stat-card .stat-value { font-size: 22px; font-weight: 700; color: #167255; }
    .stat-card .stat-label { font-size: 11px; color: #5f564a; margin-top: 2px; }

    /* Params panel */
    .params-toggle { font-size: 12px; color: #167255; cursor: pointer; background: none; border: none; padding: 0; font-weight: 400; text-decoration: underline; }
    .params-panel { display: none; margin-top: 8px; }
    .params-panel.open { display: block; }
    .params-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 8px; }
    .params-grid label { display: block; font-size: 12px; color: #4a4038; }
    .params-grid input[type="number"] { width: 100%; padding: 4px 6px; border: 1px solid #d9cdbd; border-radius: 6px; font-size: 13px; }
    .params-grid .param-hint { font-size: 10px; color: #8a7e6e; }

    /* Undo/Redo */
    .undo-redo button { font-size: 12px; padding: 4px 10px; }
    .undo-redo button:disabled { opacity: .35; }
    .undo-redo .undo-info { font-size: 11px; color: #8a7e6e; margin-left: 6px; }

    /* Responsive */
    @media (max-width: 768px) {
      body { padding: 8px; }
      .app { padding: 10px; border-radius: 10px; }
      .toolbar { grid-template-columns: 1fr 1fr; }
      .row { gap: 6px; }
      table { font-size: 11px; min-width: 560px; }
      .desc-col, .desc-cell { width: 180px; max-width: 180px; }
      .stats-grid { grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); }
    }
    @media (max-width: 480px) {
      .toolbar { grid-template-columns: 1fr; }
      .stats-grid { grid-template-columns: 1fr 1fr; }
    }
  </style>
</head>
<body>
  <!-- Loading overlay -->
  <div id="loadingOverlay" class="loading-overlay" role="alert" aria-live="assertive">
    <div class="spinner"></div>
    <div class="loading-text">処理中...</div>
  </div>

  <main class="app">
    <h1>マネーフォワード月次データ クリーナー</h1>
    <p>CSV/TSVを読み込み、重複候補を確認・復元して出力します。</p>

    <!-- Drop zone -->
    <div id="dropZone" class="drop-zone">
      <p>CSV / TSV ファイルをここにドラッグ&ドロップ</p>
      <p>または <label class="drop-zone-label" for="csvFile">ファイルを選択</label></p>
      <input id="csvFile" type="file" accept=".csv,.tsv,text/csv,text/tab-separated-values">
      <div id="fileName" style="margin-top:8px;font-weight:700;color:#2d2820;"></div>
    </div>

    <div class="row">
      <label><input id="dropTransfer" type="checkbox" checked>振替除外</label>
      <label><input id="dropZeroAmount" type="checkbox" checked>0円除外</label>
      <button id="cleanBtn" type="button">クリーニング実行</button>
      <button type="button" class="params-toggle" id="paramsToggle">詳細設定 ▼</button>
    </div>

    <div id="paramsPanel" class="params-panel">
      <div class="params-grid">
        <div>
          <label>類似度しきい値 (SIM)
            <input id="paramSim" type="number" min="0" max="1" step="0.05" value="0.9">
          </label>
          <div class="param-hint">0〜1。高いほど厳密 (既定: 0.9)</div>
        </div>
        <div>
          <label>最大日付差 (日)
            <input id="paramMaxDayDiff" type="number" min="0" max="365" step="1" value="30">
          </label>
          <div class="param-hint">異なる日付をどこまで同一とみなすか (既定: 30)</div>
        </div>
        <div>
          <label>バンドル日付窓 (日)
            <input id="paramBundleWindow" type="number" min="0" max="30" step="1" value="1">
          </label>
          <div class="param-hint">ポイント利用の束ね判定窓 (既定: 1)</div>
        </div>
      </div>
    </div>

    <div class="row">
      <select id="downloadFormat" aria-label="ダウンロード形式">
        <option value="csv_utf8_bom" selected>CSV (UTF-8 BOM / Excel推奨)</option>
        <option value="csv_utf8">CSV (UTF-8)</option>
        <option value="tsv_utf8_bom">TSV (UTF-8 BOM)</option>
        <option value="excel_xml">Excel XML 形式 (.xml)</option>
      </select>
      <button id="downloadBtn" class="secondary" type="button" disabled>ダウンロード</button>
    </div>

    <div id="status" class="status" role="status" aria-live="polite"></div>
    <div id="stats" class="panel" hidden></div>

    <section id="dupPanel" class="panel" hidden>
      <div class="section-header" id="dupSectionHeader">
        <span class="section-toggle" id="dupToggleIcon">▼</span>
        <h2>重複判定の確認</h2>
        <span id="dupSummary" class="status" role="status" aria-live="polite" style="margin:0;"></span>
      </div>
      <div id="dupSectionBody" class="section-body">
        <div class="toolbar" style="margin-top:8px;">
          <div><label>検索(内容/金額/口座)</label><input id="fSearch" type="text"></div>
          <div><label>日付From</label><input id="fFrom" type="date"></div>
          <div><label>日付To</label><input id="fTo" type="date"></div>
          <div><label>金額Min</label><input id="fMin" type="number"></div>
          <div><label>金額Max</label><input id="fMax" type="number"></div>
          <div><label>状態</label><select id="fState"><option value="all">全て</option><option value="removed">除外中</option><option value="restored">復元済み</option></select></div>
        </div>

        <div class="row">
          <button id="allRemove" type="button">全除外ON</button>
          <button id="allRestore" type="button" class="secondary">全復元</button>
          <span class="undo-redo">
            <button id="undoBtn" type="button" class="outline" disabled>↩ 元に戻す</button>
            <button id="redoBtn" type="button" class="outline" disabled>↪ やり直し</button>
            <span id="undoInfo" class="undo-info"></span>
          </span>
          <button id="filterReset" type="button" class="outline">フィルタリセット</button>
        </div>

        <div class="scroll">
          <table>
            <thead>
              <tr id="dupHead">
                <th>日付</th><th class="desc-col">内容</th><th class="amt-col">金額</th><th>口座</th><th>判定理由</th><th>日付差</th><th>重複として除外</th>
              </tr>
            </thead>
            <tbody id="dupBody"></tbody>
          </table>
        </div>
      </div>
    </section>

    <section id="previewPanel" class="panel" style="border:none;padding:0;">
      <div class="section-header" id="previewSectionHeader">
        <span class="section-toggle" id="previewToggleIcon">▼</span>
        <h2>全件プレビュー</h2>
        <span id="previewSummary" class="status" role="status" aria-live="polite" style="margin:0;"></span>
      </div>
      <div id="previewSectionBody" class="section-body">
        <div class="scroll">
          <table>
            <thead>
              <tr id="previewHead">
                <th data-key="date">日付 <span class="sort-indicator"></span></th>
                <th data-key="description" class="desc-col">内容 <span class="sort-indicator"></span></th>
                <th data-key="amount" class="amt-col">金額 <span class="sort-indicator"></span></th>
                <th data-key="major_category">大項目 <span class="sort-indicator"></span></th>
                <th data-key="minor_category">中項目 <span class="sort-indicator"></span></th>
                <th data-key="account">口座 <span class="sort-indicator"></span></th>
                <th data-key="memo">メモ <span class="sort-indicator"></span></th>
                <th data-key="is_transfer">振替 <span class="sort-indicator"></span></th>
              </tr>
            </thead>
            <tbody id="previewBody"></tbody>
          </table>
        </div>
      </div>
    </section>
  </main>

  <script src="src/core/normalize.js"></script>
<script src="src/core/csv.js"></script>
<script src="src/core/dedupe.js"></script>
<script src="src/core/export.js"></script>
<script src="src/ui/state.js"></script>
<script src="src/ui/render.js"></script>
<script src="src/main.js"></script>
</body>
</html>
