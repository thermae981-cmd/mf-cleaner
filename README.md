# SUNABA

## マネーフォワード月次データ クリーナー

- `index.html` は砂場として維持
- クリーニング機能は `mf-cleaner.html` に実装

## 使い方

1. `mf-cleaner.html` をブラウザで開く
2. マネーフォワードのCSVを選択
3. 必要なら「振替行を除外」「金額0円を除外」を切り替える
4. `クリーニング実行` を押す
5. プレビュー確認後、`CSVをダウンロード`

## クリーニング仕様

- ヘッダ名のゆれ吸収（例: `日付`, `取引日`, `金額`, `内容` など）
- CSV文字コードは `UTF-8` / `Shift_JIS` を自動判定して読み込み
- 日付形式を `YYYY-MM-DD` に統一
- 金額の `¥`, `￥`, カンマ、空白を除去して数値化
- 文字列の全角/連続空白を正規化
- 振替行と金額0行をオプションで除外

## 重複排除（出費推定）ルール

- 対象: 原則 `is_transfer === false` の行
- 判定範囲: 月次CSV全体（全口座間）
- 金額条件: 完全一致
- 日付条件: 前後 `30` 日以内
- 内容条件: 店舗キー前方一致 + 2-gram Dice類似度（`same_source` で `>= 0.90`）
- 採用行: CSVで先に出現した行を保持（後続を除外）

内容の正規化は `NFKC` + ノイズ語除去（例: `楽天市場`, `クーポン利用`, `ポイント利用`）+ 記号除去を実施します。

### 検知タイプ

- `same_source`
  - 同一ソース内の重複（負数、同額、日付近接、説明類似）
- `cross_account_1to1`
  - 異口座の1:1二重起票（負数同額）
- `cross_account_1to2_points`
  - 異口座の1:2（`負数 + ポイント正数` の純支出が別口座負数と一致）

## 画面で確認できる統計値

- `入力行`
- `必須項目あり`
- `フィルタ後`
- `重複候補グループ`
- `重複除去件数`
- `重複ルール`
- `出力行`

## 重複判定の確認と復元

- `重複判定の確認` パネルで `group / type / reason / dateDiff / netAmount` を確認可能
- 検索: 店舗名・金額・口座
- フィルタ: 日付範囲 / 金額範囲 / 状態（全て・除外中・復元済み）
- 操作:
  - 全体: `全除外ON` / `全復元`
  - グループ: グループ単位で除外⇔復元を切替
  - 個別: 行ごとに `除外` チェックを切替
- 操作結果は `重複除去件数` と `出力行` に即時反映
